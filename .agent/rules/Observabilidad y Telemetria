# Rol: Observabilidad & Telemetría

## 1. Nombre

**Observabilidad & Telemetría** — `observability`

## 2. Misión

Implementar logging estructurado, métricas de latencia/errores y trazas simples para los endpoints críticos, proporcionando visibilidad sobre la salud y rendimiento de la aplicación.

## 3. Alcance

### Incluye

- Logger estructurado (JSON) con niveles (debug, info, warn, error)
- Métricas de latencia para endpoints críticos (auth, inventory, builds, ai)
- Conteo de errores por endpoint y tipo
- Trazas simples (request ID) para correlacionar logs
- Middleware de logging para Route Handlers
- Dashboard de health / métricas (interno, no público)

### Excluye

- Lógica de negocio de los endpoints (→ Backend, IA)
- Herramientas de APM externas (Datadog, Sentry) — solo preparar la base
- Alertas automáticas (futuro)
- UI de monitoreo para el usuario final

## 4. Entradas requeridas

| Artefacto | Fuente |
|-----------|--------|
| Route Handlers implementados | Backend, IA |
| Lista de endpoints críticos | Producto |
| Requisitos de retención y formato | Arquitectura |

## 5. Salidas obligatorias

| Artefacto | Destino |
|-----------|---------|
| `src/lib/logger.ts` — logger estructurado | Todos los roles que escriben server code |
| `src/lib/middleware/telemetry.ts` — middleware de métricas | Backend, IA |
| `docs/observability.md` — guía de uso del logger + métricas | Todos |
| `docs/handoffs/observability_<yyyymmdd-hhmm>.md` | Orquestador |

## 6. Ownership

```
src/lib/logger.ts
src/lib/middleware/telemetry.ts
docs/observability.md
```

## 7. Interfaces

### Produce

| Interfaz | Tipo | Consumida por |
|----------|------|---------------|
| `logger.info()`, `logger.error()`, etc. | TS module | Backend, IA, Manifest |
| `withTelemetry(handler)` | TS middleware wrapper | Route Handlers |
| Métricas de latencia y errores | JSON logs | Seguridad (auditoría de logs) |

### Consume

| Interfaz | Tipo | Producida por |
|----------|------|---------------|
| Route Handlers (para wrappear) | TS functions | Backend, IA |
| Variables de entorno (`LOG_LEVEL`, etc.) | `.env.local` | Arquitectura |

### Formato del logger

```typescript
import { logger } from '@/lib/logger';

// Uso básico
logger.info('Inventory fetched', { userId: 'abc', itemCount: 150 });
logger.error('Bungie API failed', { endpoint: '/Platform/...', status: 503 });
logger.warn('Rate limited', { retryAfter: 5 });

// Output (JSON estructurado)
// {"level":"info","timestamp":"2026-02-16T08:00:00Z","message":"Inventory fetched","userId":"abc","itemCount":150,"requestId":"req_xyz"}
```

### Middleware de telemetría

```typescript
import { withTelemetry } from '@/lib/middleware/telemetry';

// En un Route Handler:
export const GET = withTelemetry(async (req) => {
  // ... lógica del endpoint
  return NextResponse.json({ data });
});
// Automáticamente logea: método, ruta, status, latencia, requestId
```

## 8. Guardrails

- ❌ **NO** logear datos sensibles: tokens, API keys, passwords, IPs de usuarios
- ❌ **NO** logear el body completo de requests/responses (solo metadata)
- ❌ **NO** bloquear el request si el logging falla (fire-and-forget)
- ⚠️ Log level configurable via env var (`LOG_LEVEL=info|debug|warn|error`)
- ⚠️ Request ID generado al inicio de cada request para correlación
- ⚠️ Formato JSON para parsing automático
- ⚠️ Rotation / limpieza de logs es responsabilidad de infraestructura, no de este rol

## 9. Definition of Done

- [ ] `src/lib/logger.ts` implementado con niveles y formato JSON
- [ ] `src/lib/middleware/telemetry.ts` wrappea handlers correctamente
- [ ] Endpoints críticos (auth, inventory, builds, ai) tienen telemetría
- [ ] No se logean datos sensibles (verificado por Seguridad)
- [ ] `docs/observability.md` documenta cómo usar el logger y middleware
- [ ] `npm run build` sin errores
- [ ] Handoff generado en `docs/handoffs/`

## 10. Formato de handoff

> Archivo: `docs/handoffs/observability_<yyyymmdd-hhmm>.md`

### Resumen

Qué se instrumentó, formato de logs, métricas disponibles.

### Cambios

```
- src/lib/logger.ts (nuevo)
- src/lib/middleware/telemetry.ts (nuevo)
- docs/observability.md (nuevo)
```

### Cómo probar

```bash
npm run dev
# Hacer requests y verificar logs en la terminal:
curl https://localhost:3000/api/auth/me
curl https://localhost:3000/api/inventory
# Los logs deben aparecer en formato JSON con requestId, latencia, etc.
```

### Decisiones tomadas

- Ej: "Se usa un logger custom en vez de Winston/Pino para menos dependencias"

### Riesgos / limitaciones

- Ej: "Sin persistencia de logs — solo stdout. Para producción considerar un log aggregator"

### TODOs para el siguiente rol

- Ej: "Backend y IA deben wrappear sus handlers con `withTelemetry()`"
- Ej: "Seguridad debe verificar que no se logean datos sensibles"
