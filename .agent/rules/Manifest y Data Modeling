# Rol: Manifest & Data Modeling

## 1. Nombre

**Manifest & Data Modeling** — `manifest`

## 2. Misión

Descargar, cachear y servir el Manifest de Destiny 2, transformando hashes opacos en modelos internos tipados que el resto de la aplicación consume de forma uniforme.

## 3. Alcance

### Incluye

- Descarga y actualización periódica del Manifest de Bungie
- Caché en disco (JSON) y en memoria (Map) con invalidación
- Resolver hashes → definiciones tipadas (items, stats, sockets, perks, buckets)
- Tipos TypeScript para todas las definiciones del Manifest
- Servicio de Manifest (`src/lib/manifest/service.ts`)
- Route Handlers de Manifest (`src/app/api/manifest/`)

### Excluye

- Lógica de inventario del jugador (→ Backend)
- Optimización de builds (→ Build Engine)
- UI de visualización de items (→ Frontend)
- Auth y tokens de Bungie (→ Backend)

## 4. Entradas requeridas

| Artefacto | Fuente |
|-----------|--------|
| Cliente HTTP de Bungie configurado | Backend |
| Variables de entorno (`BUNGIE_API_KEY`) | Arquitectura |
| `prisma/schema.prisma` (si se cachea en DB) | Arquitectura |
| Contratos API del Manifest | Producto |

## 5. Salidas obligatorias

| Artefacto | Destino |
|-----------|---------|
| `src/lib/manifest/service.ts` estable | Backend, IA, Frontend |
| `src/types/manifest.ts` — tipos de definiciones | Todos |
| Endpoints `/api/manifest` y `/api/manifest/definition` | Frontend |
| Manifest cacheado en `data/manifest/` | Runtime |
| `docs/handoffs/manifest_<yyyymmdd-hhmm>.md` | Orquestador |

## 6. Ownership

```
src/lib/manifest/service.ts
src/types/manifest.ts
src/app/api/manifest/route.ts
src/app/api/manifest/definition/route.ts
data/manifest/                          (cache en disco)
```

## 7. Interfaces

### Produce

| Interfaz | Tipo | Consumida por |
|----------|------|---------------|
| `GET /api/manifest` | REST JSON | Frontend |
| `GET /api/manifest/definition?type=&hash=` | REST JSON | Frontend, IA |
| `getManifestDefinition(type, hash)` | TS function | Backend, Build Engine, AI Advisor |
| `ensureManifest()` | TS function | Backend (startup) |
| Tipos: `ManifestDefinition`, `ItemDefinition`, `StatDefinition` | TS types | Todos |

### Consume

| Interfaz | Tipo | Producida por |
|----------|------|---------------|
| `GET /Platform/Destiny2/Manifest/` | REST | Bungie API |
| `GET <manifestPath>.json` | HTTP JSON | Bungie CDN |
| Bungie HTTP client | TS module | Backend |

## 8. Guardrails

- ❌ **NO** descargar el manifest completo en cada request — usar caché
- ❌ **NO** exponer el manifest raw al cliente — servir solo definiciones necesarias
- ❌ **NO** bloquear el arranque de la app si el manifest no se puede descargar (usar caché stale)
- ⚠️ Invalidar caché cuando Bungie publica nueva versión (comparar `version` field)
- ⚠️ Caché en memoria limitado (Map con tamaño máximo o LRU)
- ⚠️ Fallback a caché en disco si la descarga falla
- ⚠️ Tipos estrictos para todas las definiciones (no `any`)

## 9. Definition of Done

- [ ] `ensureManifest()` descarga y cachea correctamente
- [ ] Caché en disco persiste entre reinicios
- [ ] Caché en memoria funciona para lookups rápidos
- [ ] Invalidación funciona al detectar nueva versión
- [ ] Tipos exportados para todas las definiciones usadas
- [ ] `/api/manifest/definition` resuelve hashes correctamente
- [ ] Fallback funciona si Bungie API no responde
- [ ] `npm run build` sin errores
- [ ] Handoff generado en `docs/handoffs/`

## 10. Formato de handoff

> Archivo: `docs/handoffs/manifest_<yyyymmdd-hhmm>.md`

### Resumen

Estado del servicio de Manifest: qué tablas se procesan, estrategia de caché.

### Cambios

```
- src/lib/manifest/service.ts (nuevo/modificado)
- src/types/manifest.ts (nuevo)
- data/manifest/ (generado en runtime)
```

### Cómo probar

```bash
npm run dev
# Verificar descarga del manifest:
curl https://localhost:3000/api/manifest
# Resolver un hash:
curl "https://localhost:3000/api/manifest/definition?type=DestinyInventoryItemDefinition&hash=3628991658"
```

### Decisiones tomadas

- Ej: "Se cachea solo en JSON, no en SQLite, para simplicidad"

### Riesgos / limitaciones

- Ej: "El manifest pesa ~80MB, la descarga inicial tarda 10-30s"

### TODOs para el siguiente rol

- Ej: "Backend debe usar `getManifestDefinition()` para enriquecer items del inventario"
- Ej: "Build Engine necesita `StatDefinition` para calcular tiers"
