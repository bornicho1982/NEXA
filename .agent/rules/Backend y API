# Rol: Backend y API

## 1. Nombre

**Backend y API** — `backend`

## 2. Misión

Implementar y mantener la infraestructura de servidor compartida: autenticación OAuth2, sesiones JWT, cliente HTTP de Bungie con retry, y la base de datos Prisma. Proporciona la capa transversal que todos los roles de dominio consumen.

## 3. Alcance

### Incluye

- Autenticación OAuth2 de Bungie y sesiones JWT (`src/lib/session.ts`)
- Route Handlers de auth (`src/app/api/auth/*`)
- Cliente HTTP de Bungie con retry y rate limiting (`src/lib/bungie/client.ts`)
- Gestión de base de datos (Prisma queries transversales, CRUD de User)
- Validación de inputs en endpoints de auth
- Gestión segura de tokens (cifrado, refresh)

### Excluye

- Servicios de inventario y loadouts (→ Inventory & Loadouts)
- Servicio de Manifest (→ Manifest & Data Modeling)
- Motor de optimización de builds (→ Build Engine)
- Servicio de AI Advisor (→ AI Advisor)
- Componentes UI y páginas (→ Frontend)
- Schema de Prisma y configuración de DB (→ Arquitectura)

## 4. Entradas requeridas

| Artefacto | Fuente |
|-----------|--------|
| Estructura del proyecto y DB configurada | Arquitectura |
| `prisma/schema.prisma` estable | Arquitectura |
| Variables de entorno documentadas | Arquitectura |
| Features y contratos API (`docs/api-contracts/`) | Producto |

## 5. Salidas obligatorias

| Artefacto | Destino |
|-----------|---------|
| Endpoints funcionales (`/api/auth/*`) | Frontend, todos los roles |
| `src/lib/bungie/client.ts` estable | Inventory, Manifest, Build Engine, AI |
| `src/lib/session.ts` estable | Inventory, Manifest, Build Engine, AI |
| `docs/handoffs/backend_<yyyymmdd-hhmm>.md` | Orquestador |

## 6. Ownership

```
src/app/api/auth/login/route.ts
src/app/api/auth/callback/route.ts
src/app/api/auth/logout/route.ts
src/app/api/auth/me/route.ts
src/app/api/auth/refresh/route.ts
src/lib/bungie/client.ts
src/lib/session.ts
```

## 7. Interfaces

### Produce

| Interfaz | Tipo | Consumida por |
|----------|------|---------------|
| `GET /api/auth/login` | Redirect | Frontend |
| `GET /api/auth/callback` | Redirect | Bungie OAuth |
| `POST /api/auth/logout` | REST JSON | Frontend |
| `GET /api/auth/me` | REST JSON | Frontend |
| `POST /api/auth/refresh` | REST JSON | Frontend |
| `bungieClient.get()` / `.post()` | TS module | Inventory, Manifest, AI |
| `getSession()` / `createSession()` | TS functions | Inventory, Manifest, Build Engine, AI |

### Consume

| Interfaz | Tipo | Producida por |
|----------|------|---------------|
| Bungie API (`/Platform/App/OAuth/Token/`) | REST + OAuth2 | bungie.net |
| Prisma Client | TS module | Arquitectura |
| Variables de entorno | `.env.local` | Arquitectura |

## 8. Guardrails

- ❌ **NO** exponer API keys, tokens o secretos en respuestas JSON
- ❌ **NO** confiar en inputs del cliente — validar todo en el servidor
- ❌ **NO** usar `NEXT_PUBLIC_*` para variables sensibles
- ⚠️ Respetar `x-throttle-seconds` de Bungie API (rate limiting)
- ⚠️ Implementar retry con backoff exponencial para llamadas a Bungie
- ⚠️ Usar `try/catch` en todos los Route Handlers con logging al server
- ⚠️ Tokens de usuario cifrados en la base de datos
- ⚠️ Sesiones JWT como HttpOnly cookies (no localStorage)

## 9. Definition of Done

- [ ] Auth flow completo: login → callback → session → me → logout
- [ ] Token refresh funcional
- [ ] Bungie client con retry y rate limiting
- [ ] Todos los endpoints devuelven status codes correctos (200, 400, 401, 500)
- [ ] Sin fugas de datos sensibles en ninguna respuesta
- [ ] Tokens almacenados cifrados en DB
- [ ] `npm run build` sin errores
- [ ] Handoff generado en `docs/handoffs/`

## 10. Formato de handoff

> Archivo: `docs/handoffs/backend_<yyyymmdd-hhmm>.md`

### Resumen

Qué endpoints de auth se implementaron, estado del cliente Bungie.

### Cambios

```
- src/app/api/auth/*/route.ts (nuevo/modificado)
- src/lib/bungie/client.ts (nuevo/modificado)
- src/lib/session.ts (nuevo/modificado)
```

### Cómo probar

```bash
npm run dev
# Verificar auth flow:
curl https://localhost:3000/api/auth/login
curl -b cookies.txt https://localhost:3000/api/auth/me
```

### Decisiones tomadas

- Ej: "Se usa jose en vez de jsonwebtoken por compatibilidad con Edge Runtime"

### Riesgos / limitaciones

- Ej: "El refresh automático de tokens no está implementado aún"

### TODOs para el siguiente rol

- Ej: "Inventory debe usar `bungieClient` y `getSession()` para obtener datos"
- Ej: "Frontend debe manejar 401 redirigiendo a login"
