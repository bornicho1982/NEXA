# Job Brief — R1 Arquitectura / Tooling

## Encabezado

| Campo | Valor |
|-------|-------|
| **Rol destino** | `R1` — Arquitectura y Configuración del Proyecto |
| **Fase** | MVP |
| **Fecha** | 2026-02-16 |
| **Generado por** | R0 — Orchestrator |
| **Handoff previo** | Ninguno (primer rol en ejecutarse) |

---

## 1. Contexto actual

**Roles completados:** Ninguno.

Este es el primer rol del workflow MVP. El proyecto ya fue bootstrapped con `create-next-app` y tiene código funcional (auth, inventory, loadouts, builds, AI advisor, pages). Sin embargo, la infraestructura necesita una auditoría y ajuste para cumplir con los estándares definidos en el rol.

**Estado del proyecto:**

```json
{
  "current_phase": "MVP",
  "active_role": "R1-Architecture",
  "completed_roles": [],
  "pending_roles": ["R2-Product", "R3-Backend", "R4-Manifest", "R5-Frontend", "R6-BuildEngine", "R7-AIAdvisor", "R8-Testing", "R10-Security", "R11-Observability"]
}
```

**Lo que ya existe (auditoría del estado actual):**

| Artefacto | Estado | Problema detectado |
|-----------|--------|--------------------|
| `next.config.ts` | ✅ Existe | ❌ Falta `reactStrictMode: true` |
| `tsconfig.json` | ✅ Existe, strict: true | ⚠️ `target: "ES2017"` (debería ser `ES2022` según reglas), `allowJs: true` (debería ser `false`) |
| `eslint.config.mjs` | ✅ Existe | ⚠️ Funcional pero no incluye Prettier integration |
| `.prettierrc` | ❌ No existe | Falta crear |
| `.env.example` | ✅ Existe, 19 líneas | ✅ OK |
| `docs/env-config.md` | ❌ No existe | Falta crear (salida obligatoria) |
| `public/manifest.json` | ✅ Existe | ⚠️ Referencia iconos que no existen (`/icons/icon-192.png`) |
| `public/sw.js` | ✅ Existe | ✅ OK (install, activate, fetch con cache) |
| SW registration en layout | ✅ En `layout.tsx` vía script | ✅ OK |
| `<link rel="manifest">` | ✅ En layout.tsx head | ✅ OK (también en metadata) |
| `prisma/schema.prisma` | ✅ Existe (User, Loadout, LoadoutItem) | ✅ OK |
| `src/db/client.ts` | ❌ No existe en esa ruta | ⚠️ Está en `src/lib/db/index.ts` — ruta no coincide con ownership |
| `src/lib/config/env.ts` | ❌ No existe | Falta crear (validador tipado de env vars) |
| `package.json` scripts | ⚠️ Falta `format` | Añadir script `"format": "prettier --write ."` |
| Prettier (dependencia) | ❌ No instalado | Falta instalar `prettier` + `eslint-config-prettier` |

---

## 2. Objetivo del rol

Auditar y completar la infraestructura del proyecto para que cumpla todos los estándares definidos en el rol R1. No se implementa lógica de negocio — solo se corrige y completa la configuración base para que todos los roles posteriores trabajen sobre una base sólida y verificada.

---

## 3. Tareas concretas

### Prioridad Alta

- [ ] **T1** — Añadir `reactStrictMode: true` a `next.config.ts`
- [ ] **T2** — Corregir `tsconfig.json`: cambiar `target` a `"ES2022"`, cambiar `allowJs` a `false`
- [ ] **T3** — Crear `.prettierrc` con reglas de formato del proyecto
- [ ] **T4** — Instalar dependencias: `prettier`, `eslint-config-prettier`
- [ ] **T5** — Integrar Prettier con ESLint en `eslint.config.mjs`
- [ ] **T6** — Añadir script `"format": "prettier --write ."` a `package.json`
- [ ] **T7** — Crear `src/lib/config/env.ts` — validador tipado de variables de entorno
- [ ] **T8** — Crear `docs/env-config.md` — documentación de todas las variables

### Prioridad Media

- [ ] **T9** — Generar iconos PWA reales (192x192 y 512x512) en `public/icons/`
- [ ] **T10** — Verificar que `npm run build` compila sin errores después de los cambios
- [ ] **T11** — Verificar que `npm run lint` pasa limpio con la nueva config
- [ ] **T12** — Unificar ubicación de DB client: mover o documentar que está en `src/lib/db/index.ts`

### Prioridad Baja

- [ ] **T13** — Verificar Lighthouse PWA score (manifest + SW + icons)
- [ ] **T14** — Confirmar que variables sensibles (`BUNGIE_API_KEY`, `SESSION_SECRET`) no son `NEXT_PUBLIC_*`

---

## 4. Archivos a tocar

### Crear (nuevos)

```
.prettierrc                             — Reglas de formato
src/lib/config/env.ts                   — Validador tipado de env vars
docs/env-config.md                      — Documentación de variables
public/icons/icon-192.png               — Icono PWA 192x192
public/icons/icon-512.png               — Icono PWA 512x512
```

### Modificar

```
next.config.ts                          — Añadir reactStrictMode: true
tsconfig.json                           — target → ES2022, allowJs → false
eslint.config.mjs                       — Integrar eslint-config-prettier
package.json                            — Añadir script "format", instalar deps
```

### NO tocar (ownership de otros roles)

```
src/app/api/*                           — (ownership de R3-Backend, R6-BuildEngine, R7-AIAdvisor)
src/app/page.tsx                        — (ownership de R5-Frontend)
src/app/dashboard/*                     — (ownership de R5-Frontend)
src/lib/bungie/*                        — (ownership de R3-Backend)
src/lib/ai/*                            — (ownership de R7-AIAdvisor)
src/lib/builds/*                        — (ownership de R6-BuildEngine)
src/components/*                        — (ownership de R5-Frontend)
```

---

## 5. Interfaces / contratos a respetar

### Debe producir

| Interfaz | Tipo | Spec de referencia |
|----------|------|--------------------|
| Path aliases `@/*` → `./src/*` | TS config | `tsconfig.json` (ya existe) |
| `prisma` singleton | TS module | `src/lib/db/index.ts` (ya existe) |
| Variables de entorno tipadas y validadas | `src/lib/config/env.ts` | Nuevo |

### Debe consumir

Ninguna (primer rol).

---

## 6. Cómo validar

### Verificación automática

```bash
# 1. Build limpio
npm run build
# Esperado: 0 errores, 0 warnings tipo-error

# 2. Lint limpio
npm run lint
# Esperado: 0 errores

# 3. Format check (después de instalar Prettier)
npx prettier --check .
# Esperado: sin archivos sin formatear (o formatearlos)
```

### Verificación manual

- [ ] Abrir `next.config.ts` y verificar que `reactStrictMode: true` está presente
- [ ] Abrir `tsconfig.json` y verificar `target: "ES2022"` y `allowJs: false`
- [ ] Verificar que `.prettierrc` existe y tiene reglas
- [ ] Verificar que `src/lib/config/env.ts` exporta variables tipadas
- [ ] Verificar que `docs/env-config.md` documenta todas las variables de `.env.example`
- [ ] Verificar que `public/icons/icon-192.png` y `icon-512.png` existen
- [ ] Verificar en `.env.example` que ninguna variable sensible usa prefijo `NEXT_PUBLIC_`
- [ ] Ejecutar `npm run dev` y verificar que arranca sin errores

---

## 7. Salida esperada

### Artefactos

| Artefacto | Ruta |
|-----------|------|
| Config next + TS + ESLint + Prettier | Archivos raíz |
| Validador env tipado | `src/lib/config/env.ts` |
| Documentación de env | `docs/env-config.md` |
| Iconos PWA | `public/icons/` |
| Handoff | `docs/handoffs/architecture_20260216-0800.md` |

### Definition of Done (del archivo de rol)

- [ ] `npm run dev` arranca sin errores
- [ ] `npm run build` compila sin errores ni warnings tipo-error
- [ ] `npm run lint` limpio (0 errores)
- [ ] TypeScript strict mode activo y path aliases funcionando
- [ ] `.env.example` documenta todas las variables necesarias
- [ ] `public/manifest.json` válido y enlazado en `<head>`
- [ ] Service worker registrado en el navegador
- [ ] Lighthouse reconoce la app como PWA instalable
- [ ] Variables de entorno sensibles no accesibles desde componentes cliente

### Handoff

Al terminar, generar handoff en `docs/handoffs/architecture_<yyyymmdd-hhmm>.md`
siguiendo la plantilla de [`docs/workflows/handoff-template.md`](../workflows/handoff-template.md).
