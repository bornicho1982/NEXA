# Job Brief — R1 Arquitectura / Tooling

## Encabezado

| Campo | Valor |
|-------|-------|
| **Rol destino** | `R1` — Arquitectura y Configuración del Proyecto |
| **Fase** | MVP |
| **Fecha** | 2026-02-16 |
| **Generado por** | R0 — Orchestrator |
| **Handoff previo** | `docs/handoffs/orchestrator_20260216-0758.md` |

---

## 1. Contexto actual

**Roles completados:** R0 Orchestrator (setup inicial).

El proyecto fue bootstrapped con `create-next-app` y tiene código funcional (auth, inventory, loadouts, builds, AI advisor). La infraestructura necesita auditoría y completamiento para cumplir los estándares.

**Estado del proyecto:**

```json
{
  "current_phase": "MVP",
  "active_role": "R1-Architecture",
  "completed_roles": ["R0-Orchestrator-Setup"],
  "pending_roles": ["R2-Product", "R3-Backend", "R4-Manifest", "R5-Inventory", "R6-BuildEngine", "R7-AIAdvisor", "R8-Frontend", "R9-Testing", "R10-Security", "R11-Observability"]
}
```

**Auditoría del estado actual:**

| Artefacto | Estado | Problema |
|-----------|--------|----------|
| `next.config.ts` | ✅ Existe | ❌ Falta `reactStrictMode: true` |
| `tsconfig.json` | ✅ strict: true | ⚠️ target ES2017 (→ ES2022), allowJs: true (→ false) |
| `eslint.config.mjs` | ✅ Funcional | ⚠️ Falta Prettier integration |
| `.prettierrc` | ❌ No existe | Crear |
| `.env.example` | ✅ 19 líneas | ✅ OK |
| `src/lib/config/env.ts` | ❌ No existe | Crear |
| `docs/env-config.md` | ❌ No existe | Crear |
| `public/manifest.json` | ✅ Existe | ⚠️ Iconos referenciados no existen |
| `public/sw.js` | ✅ Existe | ✅ OK |
| SW registration | ✅ En layout.tsx | ✅ OK |
| `src/lib/db/index.ts` | ✅ Prisma client | ✅ OK |

---

## 2. Objetivo del rol

Auditar y completar la infraestructura del proyecto ejecutando 3 skills encadenadas. Al terminar, el proyecto debe compilar limpio, tener PWA instalable con iconos reales, y un validador de variables de entorno tipado. No se implementa lógica de negocio.

---

## 3. Skills a ejecutar

| Orden | Skill | Referencia | Output esperado |
|-------|-------|------------|-----------------|
| 1 | `repo-bootstrap` | [`docs/skills/repo-bootstrap.md`](../skills/repo-bootstrap.md) | tsconfig ES2022/strict, ESLint+Prettier, scripts npm |
| 2 | `pwa-setup` | [`docs/skills/pwa-setup.md`](../skills/pwa-setup.md) | manifest.json, iconos 192+512, SW funcional |
| 3 | `env-validation` | [`docs/skills/env-validation.md`](../skills/env-validation.md) | `src/lib/config/env.ts`, `docs/env-config.md` |

**Para cada skill, seguir el procedimiento documentado en su archivo.**

---

## 4. Tareas concretas

### Skill `repo-bootstrap` (prioridad alta)

- [ ] **RB-1** Añadir `reactStrictMode: true` a `next.config.ts`
- [ ] **RB-2** Corregir `tsconfig.json`: target → ES2022, allowJs → false
- [ ] **RB-3** Instalar dependencias: `prettier`, `eslint-config-prettier`
- [ ] **RB-4** Crear `.prettierrc` con reglas de formato
- [ ] **RB-5** Integrar Prettier con ESLint en `eslint.config.mjs`
- [ ] **RB-6** Añadir script `"format": "prettier --write ."` a `package.json`
- [ ] **RB-7** Ejecutar `npm run build` + `npm run lint` — ambos exit code 0

### Skill `pwa-setup` (prioridad alta)

- [ ] **PWA-1** Verificar `public/manifest.json` tiene todos los campos requeridos
- [ ] **PWA-2** Generar iconos PWA reales: `public/icons/icon-192.png` (192x192)
- [ ] **PWA-3** Generar iconos PWA reales: `public/icons/icon-512.png` (512x512)
- [ ] **PWA-4** Verificar que SW está registrado en `src/app/layout.tsx`
- [ ] **PWA-5** Verificar que `<link rel="manifest">` está en head
- [ ] **PWA-6** Verificar Lighthouse PWA score

### Skill `env-validation` (prioridad alta)

- [ ] **ENV-1** Crear `src/lib/config/env.ts` con validador tipado
- [ ] **ENV-2** Crear `docs/env-config.md` con tabla de todas las variables
- [ ] **ENV-3** Verificar que ninguna variable sensible usa `NEXT_PUBLIC_`
- [ ] **ENV-4** Probar que faltar una variable requerida lanza error claro

### Adicionales (no cubiertas por skills)

- [ ] **EX-1** Verificar que `src/lib/db/index.ts` exporta Prisma singleton correctamente
- [ ] **EX-2** Confirmar path aliases `@/*` → `./src/*` funcionan

---

## 5. Archivos a tocar

### Crear (nuevos)

```
.prettierrc                              — (repo-bootstrap)
src/lib/config/env.ts                    — (env-validation)
docs/env-config.md                       — (env-validation)
public/icons/icon-192.png                — (pwa-setup)
public/icons/icon-512.png                — (pwa-setup)
```

### Modificar

```
next.config.ts                           — (repo-bootstrap) reactStrictMode
tsconfig.json                            — (repo-bootstrap) target, allowJs
eslint.config.mjs                        — (repo-bootstrap) prettier integration
package.json                             — (repo-bootstrap) script format, deps
```

### NO tocar (ownership de otros roles)

```
src/app/api/*                            — R3 Backend, R5 Inventory, R6 Build Engine, R7 AI
src/app/page.tsx, /dashboard, /inventory — R8 Frontend
src/lib/bungie/*                         — R3 Backend
src/lib/inventory/*                      — R5 Inventory
src/lib/loadouts/*                       — R5 Inventory
src/lib/manifest/*                       — R4 Manifest
src/lib/builds/*                         — R6 Build Engine
src/lib/ai/*                             — R7 AI Advisor
src/components/*                         — R8 Frontend
```

---

## 6. Interfaces / contratos a respetar

### Debe producir

| Interfaz | Tipo | Spec de referencia |
|----------|------|------------------|
| Path aliases `@/*` → `./src/*` | TS config | `tsconfig.json` (ya existe) |
| Prisma singleton | TS module export | `src/lib/db/index.ts` (ya existe) |
| Variables de entorno tipadas | TS module export | `src/lib/config/env.ts` (nuevo) |

### Debe consumir

Ninguna (primer rol de implementación).

---

## 7. Cómo validar

### Quality Gate del rol

```bash
# 1. Build limpio
npm run build
# Esperado: 0 errores, exit code 0

# 2. Lint limpio
npm run lint
# Esperado: 0 errores, exit code 0

# 3. Format check
npx prettier --check .
# Esperado: sin archivos sin formatear
```

### Checks de skills

**Skill `repo-bootstrap`:**

- [ ] `npm run build` pasa limpio
- [ ] `npm run lint` pasa limpio
- [ ] `npx prettier --check .` sin archivos pendientes
- [ ] `tsconfig.json` tiene strict: true y target: ES2022
- [ ] `.prettierrc` existe con reglas definidas

**Skill `pwa-setup`:**

- [ ] manifest.json parseable sin errores en DevTools
- [ ] Iconos cargan correctamente (no 404)
- [ ] Service worker registrado y activo
- [ ] Lighthouse reconoce la app como "installable"

**Skill `env-validation`:**

- [ ] `src/lib/config/env.ts` exporta variables tipadas
- [ ] Faltar una variable requerida lanza error descriptivo
- [ ] Variables opcionales tienen defaults razonables
- [ ] `docs/env-config.md` documenta todas las variables
- [ ] Ninguna variable sensible es `NEXT_PUBLIC_*`

### Verificación manual

- [ ] `npm run dev` arranca sin errores
- [ ] Abrir DevTools → Application → Manifest: sin errores
- [ ] Abrir DevTools → Application → Service Workers: registrado
- [ ] Path aliases `@/` funcionan en imports

---

## 8. Artefactos esperados

| Artefacto | Fuente (Skill) | Ruta |
|-----------|---------------|------|
| tsconfig + eslint + prettier configurados | `repo-bootstrap` | Archivos raíz |
| `.prettierrc` | `repo-bootstrap` | `.prettierrc` |
| Manifest PWA válido | `pwa-setup` | `public/manifest.json` |
| Iconos PWA | `pwa-setup` | `public/icons/icon-{192,512}.png` |
| Validador env tipado | `env-validation` | `src/lib/config/env.ts` |
| Documentación env | `env-validation` | `docs/env-config.md` |
| Handoff | Rol | `docs/handoffs/architecture_<yyyymmdd-hhmm>.md` |

---

## 9. Definition of Done

- [ ] `npm run dev` arranca sin errores
- [ ] `npm run build` compila sin errores ni warnings tipo-error
- [ ] `npm run lint` limpio (0 errores)
- [ ] TypeScript strict mode activo y path aliases funcionando
- [ ] `.env.example` documenta todas las variables necesarias
- [ ] `public/manifest.json` válido y enlazado en `<head>`
- [ ] Service worker registrado en el navegador
- [ ] Lighthouse reconoce la app como PWA instalable
- [ ] Variables de entorno sensibles no accesibles desde componentes cliente

### Handoff

Al terminar, generar handoff en `docs/handoffs/architecture_<yyyymmdd-hhmm>.md`
siguiendo la plantilla de [`docs/workflows/handoff-template.md`](../workflows/handoff-template.md).
