# Handoff: R3 Backend & Integración

**Fecha**: 2026-02-16
**Rol**: R3 Backend
**Estado**: ✅ Completado

## Resumen Ejecutivo

Se ha implementado el núcleo del servidor backend, incluyendo la capa de autenticación completa con Bungie OAuth, manejo robusto de tokens (refresh automático) y protección de rutas mediante Middleware. La base de datos está inicializada con el esquema de usuarios.

## Entregables Técnicos

### 1. Autenticación Robusta

- **Middleware** (`src/middleware.ts`): Proteje rutas críticas (`/dashboard`, `/inventory`, `/api/*`) verificando JWT de sesión en Edge.
- **Service User** (`src/lib/auth/user.ts`): Helper `getAuthenticatedUser()` que recupera al usuario de BD y **renueva automáticamente** el token de Bungie si ha expirado (o está próximo a expirar).
- **Callback OAuth** (`src/app/api/auth/callback/route.ts`): Lógica mejorada para detectar correctamente la cuenta primaria de **Cross Save**.

### 2. Cliente Bungie

- **Refactor**: `src/lib/bungie/client.ts` y `auth.ts` actualizados para usar la configuración centralizada `src/lib/config/env.ts` (Type-safe env vars).

### 3. Base de Datos

- **Prisma**: Esquema sincronizado con SQLite (`dev.db`). Modelos `User`, `Loadout`, `LoadoutItem` listos.

## Flujo de Auth Implementado

1. **Login**: Redirect a Bungie.
2. **Callback**:
   - Intercambio de Code -> Token.
   - Detección de Cross Save.
   - Upsert en SQLite.
   - Creación de Session Cookie (JWT).
3. **Acceso Protegido** (ej: `/api/inventory`):
   - Middleware valida Cookie.
   - Handler llama `getAuthenticatedUser()`.
   - Si Bungie Token expiró -> Refresh -> Update DB -> Return valid User.
   - Si Refresh falla -> Null -> 401.

## Siguientes Pasos (Handoff a R4)

- **R4 Manifest** debe implementar la descarga y parseo de las definiciones de Destiny 2 (Manifest), vital para que el inventario muestre nombres e iconos en lugar de Hashes.
